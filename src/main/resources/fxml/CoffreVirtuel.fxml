<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.shape.*?>
<?import javafx.geometry.Insets?>
<?import javafx.collections.FXCollections?>
<?import java.lang.String?>

<VBox xmlns="http://javafx.com/javafx/17"
      xmlns:fx="http://javafx.com/fxml/1"
      fx:controller="com.nexora.bank.controllers.CoffreVirtuelController"
      stylesheets="@../css/CoffreVirtuel.css"
      styleClass="nx-entity-container" spacing="24">

    <!-- ============================================= -->
    <!-- STAT CARDS (Mini Dashboard) -->
    <!-- ============================================= -->
    <HBox spacing="24" styleClass="nx-stats-row">
        <!-- Stat Card 1: Total Coffres CrÃ©Ã©s -->
        <VBox styleClass="nx-stat-card" HBox.hgrow="ALWAYS">
            <HBox alignment="CENTER_LEFT" spacing="16">
                <StackPane styleClass="nx-stat-card-icon, nx-stat-card-icon-teal">
                    <SVGPath content="M20 7h-7m7 10h-7m4-5h-4m-9 0a9 9 0 1 0 0-18 9 9 0 0 0 0 18z"/>
                </StackPane>
                <VBox spacing="4">
                    <Label fx:id="lblTotalCoffres" text="0" styleClass="nx-stat-card-value"/>
                    <Label text="Total Coffres CrÃ©Ã©s" styleClass="nx-stat-card-label"/>
                </VBox>
                <Region HBox.hgrow="ALWAYS"/>
                <VBox alignment="CENTER_RIGHT">
                    <Label text="+5%" styleClass="nx-stat-badge, nx-stat-badge-success"/>
                </VBox>
            </HBox>
        </VBox>

        <!-- Stat Card 2: Montant Total StockÃ© -->
        <VBox styleClass="nx-stat-card" HBox.hgrow="ALWAYS">
            <HBox alignment="CENTER_LEFT" spacing="16">
                <StackPane styleClass="nx-stat-card-icon, nx-stat-card-icon-gold">
                    <SVGPath content="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3"/>
                </StackPane>
                <VBox spacing="4">
                    <Label fx:id="lblMontantTotal" text="0.00 DT" styleClass="nx-stat-card-value"/>
                    <Label text="Montant Total StockÃ©" styleClass="nx-stat-card-label"/>
                </VBox>
                <Region HBox.hgrow="ALWAYS"/>
                <VBox alignment="CENTER_RIGHT">
                    <Label text="+12%" styleClass="nx-stat-badge, nx-stat-badge-success"/>
                </VBox>
            </HBox>
        </VBox>

        <!-- Stat Card 3: Coffres Actifs -->
        <VBox styleClass="nx-stat-card" HBox.hgrow="ALWAYS">
            <HBox alignment="CENTER_LEFT" spacing="16">
                <StackPane styleClass="nx-stat-card-icon, nx-stat-card-icon-success">
                    <SVGPath content="M9 12l2 2 4-4m6 2a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/>
                </StackPane>
                <VBox spacing="4">
                    <Label fx:id="lblCoffresActifs" text="0" styleClass="nx-stat-card-value"/>
                    <Label text="Coffres Actifs" styleClass="nx-stat-card-label"/>
                </VBox>
                <Region HBox.hgrow="ALWAYS"/>
                <VBox alignment="CENTER_RIGHT">
                    <Label text="+8%" styleClass="nx-stat-badge, nx-stat-badge-success"/>
                </VBox>
            </HBox>
        </VBox>
    </HBox>

    <!-- ============================================= -->
    <!-- MAIN CONTENT: FORM + TABLE -->
    <!-- ============================================= -->
    <HBox spacing="24" VBox.vgrow="ALWAYS">

        <!-- ============================================= -->
        <!-- FORM SECTION -->
        <!-- ============================================= -->
        <VBox styleClass="nx-card" prefWidth="300" minWidth="300" spacing="0">
            <!-- Form Header -->
            <HBox styleClass="nx-card-header" alignment="CENTER_LEFT" spacing="12">
                <StackPane styleClass="nx-card-header-icon">
                    <SVGPath content="M12 15v2m-6 4h12a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2zm10-10V7a4 4 0 0 0-8 0v4h8z"/>
                </StackPane>
                <VBox spacing="2">
                    <Label text="Coffre Virtuel" styleClass="nx-card-title"/>
                    <Label text="Ajouter ou modifier un coffre" styleClass="nx-card-subtitle"/>
                </VBox>
            </HBox>

            <!-- Form Body -->
            <VBox styleClass="nx-card-body" spacing="16">
                <!-- Nom -->
                <VBox styleClass="nx-form-group" spacing="8">
                    <Label text="Nom du Coffre" styleClass="nx-label"/>
                    <HBox styleClass="nx-input-wrapper">
                        <SVGPath content="M20 7h-7m7 10h-7m4-5h-4" styleClass="nx-input-icon"/>
                        <TextField fx:id="txtNom" promptText="Ex: Ã‰pargne Vacances" styleClass="nx-input" HBox.hgrow="ALWAYS"/>
                    </HBox>
                    <Label fx:id="lblNomError" style="-fx-text-fill: red;" />
                </VBox>

                <!-- Objectif Montant -->
                <VBox styleClass="nx-form-group" spacing="8">
                    <Label text="Objectif Montant (DT)" styleClass="nx-label"/>
                    <HBox styleClass="nx-input-wrapper">
                        <SVGPath content="M13 10V3L4 14h7v7l9-11h-7z" styleClass="nx-input-icon"/>
                        <TextField fx:id="txtObjectifMontant" promptText="Ex: 10000.00" styleClass="nx-input" HBox.hgrow="ALWAYS"/>
                    </HBox>
                    <Label fx:id="lblObjectifError" style="-fx-text-fill: red;" />
                </VBox>

                <!-- Montant Actuel -->
                <VBox styleClass="nx-form-group" spacing="8">
                    <Label text="Montant Actuel (DT)" styleClass="nx-label"/>
                    <HBox styleClass="nx-input-wrapper">
                        <SVGPath content="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" styleClass="nx-input-icon"/>
                        <TextField fx:id="txtMontantActuel" promptText="0.00" styleClass="nx-input" HBox.hgrow="ALWAYS"/>
                    </HBox>
                    <Label fx:id="lblMontantError" style="-fx-text-fill: red;" />
                </VBox>

                <!-- Date CrÃ©ation -->
                <VBox styleClass="nx-form-group" spacing="8">
                    <Label text="Date de CrÃ©ation" styleClass="nx-label"/>
                    <HBox styleClass="nx-input-wrapper">
                        <SVGPath content="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z" styleClass="nx-input-icon"/>
                        <DatePicker fx:id="dpDateCreation" promptText="SÃ©lectionner une date" styleClass="nx-datepicker" HBox.hgrow="ALWAYS"/>
                    </HBox>
                    <Label fx:id="lblDateCreationError" style="-fx-text-fill: red;" />
                </VBox>

                <!-- Date Objectif -->
                <VBox styleClass="nx-form-group" spacing="8">
                    <Label text="Date Objectif" styleClass="nx-label"/>
                    <HBox styleClass="nx-input-wrapper">
                        <SVGPath content="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" styleClass="nx-input-icon"/>
                        <DatePicker fx:id="dpDateObjectif" promptText="Date cible" styleClass="nx-datepicker" HBox.hgrow="ALWAYS"/>
                    </HBox>
                    <Label fx:id="lblDateObjectifError" style="-fx-text-fill: red;" />
                </VBox>

                <!-- Status -->
                <VBox styleClass="nx-form-group" spacing="8">
                    <Label text="Statut" styleClass="nx-label"/>
                    <ComboBox fx:id="cmbStatus" promptText="SÃ©lectionner un statut" styleClass="nx-select" maxWidth="Infinity">
                        <items>
                            <FXCollections fx:factory="observableArrayList">
                                <String fx:value="Actif"/>
                                <String fx:value="BloquÃ©"/>
                                <String fx:value="ClÃ´turÃ©"/>
                            </FXCollections>
                        </items>
                    </ComboBox>
                </VBox>

                <!-- IdCompte jointure -->

                <VBox styleClass="nx-form-group" spacing="8">
                    <Label text="Compte Bancaire" styleClass="nx-label"/>
                    <HBox styleClass="nx-input-wrapper">
                        <SVGPath content="M3 10h18..." styleClass="nx-input-icon"/>
                        <ComboBox fx:id="cmbCompteBancaire" promptText="SÃ©lectionner un compte"
                                  styleClass="nx-select" maxWidth="Infinity" HBox.hgrow="ALWAYS"/>
                    </HBox>
                    <Label fx:id="lblCompteError" style="-fx-text-fill: red;" visible="false"/>
                </VBox>

                <!-- Est VerrouillÃ© (CheckBox) -->
                <VBox styleClass="nx-form-group" spacing="8">
                    <HBox alignment="CENTER_LEFT" spacing="12">
                        <CheckBox fx:id="chkEstVerrouille" styleClass="nx-checkbox"/>
                        <VBox spacing="2">
                            <Label text="Coffre VerrouillÃ©" styleClass="nx-label"/>
                            <Label text="EmpÃªcher les retraits jusqu'Ã  la date objectif" styleClass="nx-helper-text"/>
                        </VBox>
                    </HBox>
                </VBox>
            </VBox>

            <!-- Form Footer with Buttons -->
            <VBox styleClass="nx-card-footer" spacing="15" alignment="CENTER_RIGHT">

                <!-- ðŸ”µ Bouton Ajouter en haut (large) -->
                <Button fx:id="btnAjouter"
                        text="Enregistrer "
                        styleClass="nx-btn, nx-btn-primary"
                        onAction="#handleAjouter"
                        maxWidth="Infinity"
                        prefHeight="140">

                    <graphic>
                        <SVGPath content="M12 5v14M5 12h14" styleClass="nx-btn-icon"/>
                    </graphic>
                </Button>

                <!-- ðŸŸ¥ Ligne Supprimer + Annuler -->
                <HBox spacing="12" alignment="CENTER_RIGHT">

                    <Button fx:id="btnAnnuler"
                            text="Annuler"
                            styleClass="nx-btn, nx-btn-outline"
                            onAction="#handleAnnuler"
                            prefWidth="160"
                            maxWidth="Infinity"
                            HBox.hgrow="ALWAYS">

                        <graphic>
                            <SVGPath content="M6 18L18 6M6 6l12 12"
                                     styleClass="nx-btn-icon"/>
                        </graphic>
                    </Button>

                    <Button fx:id="btnSupprimer"
                            text="Supprimer"
                            styleClass="nx-btn, nx-btn-danger"
                            onAction="#handleSupprimer"
                            prefWidth="140"
                            maxWidth="Infinity"
                            HBox.hgrow="ALWAYS">

                        <graphic>
                            <SVGPath content="M19 7l-.867 12.142A2 2 0 0 1 16.138 21H7.862a2 2 0 0 1-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 0 0-1-1h-4a1 1 0 0 0-1 1v3M4 7h16"
                                     styleClass="nx-btn-icon"/>
                        </graphic>
                    </Button>
                </HBox>

            </VBox>
        </VBox>

        <!-- ============================================= -->
        <!-- TABLE SECTION -->
        <!-- ============================================= -->
        <VBox styleClass="nx-card" HBox.hgrow="ALWAYS" spacing="0">
            <!-- Table Header -->
            <HBox styleClass="nx-card-header" alignment="CENTER_LEFT" spacing="16">
                <VBox spacing="2" HBox.hgrow="ALWAYS">
                    <Label text="Liste des Coffres Virtuels" styleClass="nx-card-title"/>
                    <Label text="GÃ©rer tous les coffres d'Ã©pargne" styleClass="nx-card-subtitle"/>
                </VBox>

                <!-- Search Box -->
                <HBox styleClass="nx-table-search" alignment="CENTER_LEFT" spacing="8">
                    <SVGPath content="M21 21l-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z" styleClass="nx-search-icon-sm"/>
                    <TextField fx:id="txtRecherche" promptText="Rechercher..." styleClass="nx-search-input-sm" prefWidth="200"/>
                </HBox>

                <!-- Sort Button -->
                <MenuButton styleClass="nx-btn, nx-btn-outline, nx-btn-sm" text="Trier" mnemonicParsing="false">
                    <graphic>
                        <HBox alignment="CENTER_LEFT" spacing="8">
                            <SVGPath content="M3 6h18M6 12h12M9 18h6" styleClass="nx-btn-icon" />
                            <Label text="Trier" style="-fx-text-fill: #1F2937; -fx-font-size: 13px; -fx-font-weight: 600;" />
                        </HBox>
                    </graphic>
                    <items>
                        <MenuItem text="Par id" onAction="#trierParId"/>
                        <MenuItem text="Par Nom" onAction="#trierParNom"/>
                        <MenuItem text="Par Montant Objectif" onAction="#trierParObjectif"/>
                        <MenuItem text="Par Montant Actuel" onAction="#trierParMontantActuel"/>
                        <MenuItem text="Par Date CrÃ©ation" onAction="#trierParDateCreation"/>
                        <MenuItem text="Par Statut" onAction="#trierParStatut"/>
                    </items>
                </MenuButton>

                <!-- Export PDF Button -->
                <Button text="Export PDF" styleClass="nx-btn, nx-btn-secondary-sm" onAction="#exporterPDF">
                    <graphic>
                        <SVGPath content="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8" styleClass="nx-btn-icon"/>
                    </graphic>
                </Button>
            </HBox>

            <!-- Table Body -->
            <VBox styleClass="nx-table-container" VBox.vgrow="ALWAYS">
                <TableView fx:id="tableCoffres" styleClass="nx-table" VBox.vgrow="ALWAYS">
                    <columns>
                        <TableColumn fx:id="colID" text="id" prefWidth="50" styleClass="nx-table-col"/>
                        <TableColumn fx:id="colNom" text="Nom" prefWidth="150" styleClass="nx-table-col"/>
                        <TableColumn fx:id="colObjectif" text="Objectif (DT)" prefWidth="120" styleClass="nx-table-col"/>
                        <TableColumn fx:id="colMontantActuel" text="Actuel (DT)" prefWidth="120" styleClass="nx-table-col"/>
                        <TableColumn fx:id="colProgression" text="Progression" prefWidth="120" styleClass="nx-table-col"/>
                        <TableColumn fx:id="colDateCreation" text="Date CrÃ©ation" prefWidth="120" styleClass="nx-table-col"/>
                        <TableColumn fx:id="colDateObjectif" text="Date Objectif" prefWidth="120" styleClass="nx-table-col"/>
                        <TableColumn fx:id="colStatus" text="Statut" prefWidth="80" styleClass="nx-table-col"/>
                        <TableColumn fx:id="colVerrouille" text="VerrouillÃ©" prefWidth="30" styleClass="nx-table-col"/>
                        <TableColumn fx:id="colCompte" text="NÂ° Compte" prefWidth="130" styleClass="nx-table-col"/>
                        <TableColumn fx:id="colActions" text="Actions" prefWidth="100" minWidth="100" />
                    </columns>
                    <placeholder>
                        <VBox alignment="CENTER" spacing="16" styleClass="nx-table-empty">
                            <SVGPath content="M12 15v2m-6 4h12a2 2 0 0 0 2-2v-6a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2zm10-10V7a4 4 0 0 0-8 0v4h8z" styleClass="nx-empty-icon"/>
                            <Label text="Aucun coffre trouvÃ©" styleClass="nx-empty-title"/>
                            <Label text="Commencez par crÃ©er un nouveau coffre virtuel" styleClass="nx-empty-subtitle"/>
                        </VBox>
                    </placeholder>
                </TableView>
            </VBox>

            <!-- Table Footer -->
            <HBox styleClass="nx-card-footer, nx-table-footer" alignment="CENTER" spacing="16">
                <Label fx:id="lblTableInfo" text="Affichage de 0 Ã  0 sur 0 entrÃ©es" styleClass="nx-table-info"/>
                <Region HBox.hgrow="ALWAYS"/>

                <!-- SMS Button -->
                <Button text="Envoyer SMS" styleClass="nx-btn, nx-btn-gold" onAction="#envoyerSMS">
                    <graphic>
                        <SVGPath content="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" styleClass="nx-btn-icon"/>
                    </graphic>
                </Button>

                <!-- Pagination -->
                <HBox styleClass="nx-pagination" spacing="4">
                    <Button text="&lt;&lt;" styleClass="nx-page-btn" onAction="#pageFirst"/>
                    <Button text="&lt;" styleClass="nx-page-btn" onAction="#pagePrev"/>
                    <Button text="1" styleClass="nx-page-btn, nx-page-btn-active"/>
                    <Button text="2" styleClass="nx-page-btn"/>
                    <Button text="3" styleClass="nx-page-btn"/>
                    <Button text="&gt;" styleClass="nx-page-btn" onAction="#pageNext"/>
                    <Button text="&gt;&gt;" styleClass="nx-page-btn" onAction="#pageLast"/>
                </HBox>
            </HBox>
        </VBox>
    </HBox>
</VBox>

