<?xml version="1.0" encoding="UTF-8"?>
<?import java.lang.String?>
<?import javafx.collections.FXCollections?>
<?import javafx.geometry.Insets?>
<?import javafx.scene.control.Button?>
<?import javafx.scene.control.CheckBox?>
<?import javafx.scene.control.ComboBox?>
<?import javafx.scene.control.DatePicker?>
<?import javafx.scene.control.Label?>
<?import javafx.scene.control.ScrollPane?>
<?import javafx.scene.control.Separator?>
<?import javafx.scene.control.TextField?>
<?import javafx.scene.layout.ColumnConstraints?>
<?import javafx.scene.layout.FlowPane?>
<?import javafx.scene.layout.GridPane?>
<?import javafx.scene.layout.HBox?>
<?import javafx.scene.layout.Priority?>
<?import javafx.scene.layout.Region?>
<?import javafx.scene.layout.StackPane?>
<?import javafx.scene.layout.VBox?>
<?import org.kordamp.ikonli.javafx.FontIcon?>

<VBox xmlns="http://javafx.com/javafx/17"
      xmlns:fx="http://javafx.com/fxml/1"
      fx:controller="com.nexora.bank.controllers.UserDashboardAccountsSectionController"
      spacing="0"
      styleClass="comptes-section"
      stylesheets="@../../css/sections/UserDashboardAccountsSection.css">

    <!-- ═══════════════════════════════════════════════════════════════
         SECTION HEADER (inchangé)
         ═══════════════════════════════════════════════════════════════ -->
    <VBox styleClass="section-header" spacing="16">
        <padding><Insets top="28" right="32" bottom="24" left="32"/></padding>
        <HBox alignment="CENTER_LEFT" spacing="16">
            <StackPane styleClass="section-icon-container">
                <FontIcon iconLiteral="fas-wallet" styleClass="section-icon"/>
            </StackPane>
            <VBox spacing="4" HBox.hgrow="ALWAYS">
                <Label text="Gestion des comptes" styleClass="section-title"/>
                <Label text="Gerer les comptes, suivre les soldes et configurer les coffres virtuels"
                       styleClass="section-subtitle"/>
            </VBox>
            <HBox spacing="10" alignment="CENTER_RIGHT">
                <Button styleClass="header-btn-secondary" onAction="#refreshData">
                    <graphic>
                        <HBox spacing="8" alignment="CENTER">
                            <FontIcon iconLiteral="fas-sync-alt" styleClass="header-btn-icon"/>
                            <Label text="Actualiser" styleClass="header-btn-label"/>
                        </HBox>
                    </graphic>
                </Button>
                <Button styleClass="header-btn-primary" onAction="#toggleCoffreForm">
                    <graphic>
                        <HBox spacing="8" alignment="CENTER">
                            <FontIcon iconLiteral="fas-plus" styleClass="header-btn-icon-light"/>
                            <Label text="Nouveau coffre" styleClass="header-btn-label-light"/>
                        </HBox>
                    </graphic>
                </Button>
            </HBox>
        </HBox>
    </VBox>

    <!-- ═══════════════════════════════════════════════════════════════
         KPI CARDS (inchangé)
         ═══════════════════════════════════════════════════════════════ -->
    <HBox styleClass="kpi-container" spacing="20">
        <padding><Insets top="0" right="32" bottom="24" left="32"/></padding>

        <!-- Solde Total -->
        <VBox styleClass="kpi-card" HBox.hgrow="ALWAYS" spacing="14">
            <HBox spacing="12" alignment="CENTER_LEFT">
                <StackPane styleClass="kpi-icon-wrapper kpi-icon-primary">
                    <FontIcon iconLiteral="fas-coins" styleClass="kpi-icon"/>
                </StackPane>
                <VBox spacing="2">
                    <Label text="SOLDE TOTAL" styleClass="kpi-title"/>
                    <Label text="Sur tous les comptes" styleClass="kpi-description"/>
                </VBox>
            </HBox>
            <HBox alignment="CENTER_LEFT" spacing="8">
                <Label fx:id="lblTotalBalance" text="0.00 DT" styleClass="kpi-value"/>
                <HBox styleClass="kpi-trend kpi-trend-up" spacing="4" alignment="CENTER">
                    <FontIcon iconLiteral="fas-arrow-up" styleClass="kpi-trend-icon"/>
                    <Label fx:id="lblTotalBalanceTrend" text="+0%" styleClass="kpi-trend-text"/>
                </HBox>
            </HBox>
        </VBox>

        <!-- Comptes Actifs -->
        <VBox styleClass="kpi-card" HBox.hgrow="ALWAYS" spacing="14">
            <HBox spacing="12" alignment="CENTER_LEFT">
                <StackPane styleClass="kpi-icon-wrapper kpi-icon-secondary">
                    <FontIcon iconLiteral="fas-university" styleClass="kpi-icon"/>
                </StackPane>
                <VBox spacing="2">
                    <Label text="COMPTES ACTIFS" styleClass="kpi-title"/>
                    <Label text="Actuellement utilises" styleClass="kpi-description"/>
                </VBox>
            </HBox>
            <HBox alignment="CENTER_LEFT" spacing="12">
                <Label fx:id="lblActiveAccounts" text="0" styleClass="kpi-value"/>
                <Label text="comptes" styleClass="kpi-unit"/>
            </HBox>
        </VBox>

        <!-- Coffres Virtuels -->
        <VBox styleClass="kpi-card" HBox.hgrow="ALWAYS" spacing="14">
            <HBox spacing="12" alignment="CENTER_LEFT">
                <StackPane styleClass="kpi-icon-wrapper kpi-icon-accent">
                    <FontIcon iconLiteral="fas-piggy-bank" styleClass="kpi-icon"/>
                </StackPane>
                <VBox spacing="2">
                    <Label text="COFFRES VIRTUELS" styleClass="kpi-title"/>
                    <Label text="Objectifs d epargne actifs" styleClass="kpi-description"/>
                </VBox>
            </HBox>
            <HBox alignment="CENTER_LEFT" spacing="12">
                <Label fx:id="lblVaultCount" text="0" styleClass="kpi-value"/>
                <Label text="objectifs en cours" styleClass="kpi-unit"/>
            </HBox>
        </VBox>

        <!-- Sante du Compte -->
        <VBox styleClass="kpi-card kpi-card-highlight" HBox.hgrow="ALWAYS" spacing="14">
            <HBox spacing="12" alignment="CENTER_LEFT">
                <StackPane styleClass="kpi-icon-wrapper kpi-icon-highlight">
                    <FontIcon iconLiteral="fas-shield-alt" styleClass="kpi-icon-light"/>
                </StackPane>
                <VBox spacing="2">
                    <Label text="SANTE DU COMPTE" styleClass="kpi-title-light"/>
                    <Label text="Etat de securite" styleClass="kpi-description-light"/>
                </VBox>
            </HBox>
            <HBox alignment="CENTER_LEFT" spacing="10">
                <Label text="Excellent" styleClass="kpi-value-light"/>
                <StackPane styleClass="health-indicator">
                    <FontIcon iconLiteral="fas-check-circle" styleClass="health-icon"/>
                </StackPane>
            </HBox>
        </VBox>
    </HBox>

    <!-- ═══════════════════════════════════════════════════════════════
         MAIN CONTENT (Form + Account Grid)
         ═══════════════════════════════════════════════════════════════ -->
    <HBox spacing="24" VBox.vgrow="ALWAYS">
        <padding><Insets top="0" right="32" bottom="32" left="32"/></padding>

        <!-- ── LEFT : Account Detail Form (inchangé) ────────────────── -->
        <VBox styleClass="content-card" prefWidth="480" spacing="0">
            <HBox styleClass="card-header" spacing="14" alignment="CENTER_LEFT">
                <StackPane styleClass="card-header-icon">
                    <FontIcon iconLiteral="fas-edit" styleClass="card-header-icon-glyph"/>
                </StackPane>
                <VBox spacing="2">
                    <Label text="Details du compte" styleClass="card-header-title"/>
                    <Label text="Voir et modifier les informations du compte"
                           styleClass="card-header-subtitle"/>
                </VBox>
            </HBox>

            <VBox styleClass="card-body" spacing="20">
                <GridPane hgap="16" vgap="16" styleClass="form-grid">
                    <columnConstraints>
                        <ColumnConstraints percentWidth="38"/>
                        <ColumnConstraints percentWidth="62"/>
                    </columnConstraints>

                    <!-- Numero de compte -->
                    <VBox spacing="6" GridPane.rowIndex="0" GridPane.columnIndex="0"
                          GridPane.columnSpan="2">
                        <Label text="Numero de compte" styleClass="form-label"/>
                        <HBox styleClass="input-group" spacing="0">
                            <StackPane styleClass="input-prefix">
                                <FontIcon iconLiteral="fas-hashtag" styleClass="input-prefix-icon"/>
                            </StackPane>
                            <TextField fx:id="txtAccountNumber"
                                       promptText="Saisir le numero de compte"
                                       styleClass="text-field input-with-prefix"
                                       HBox.hgrow="ALWAYS"/>
                        </HBox>
                        <Label fx:id="lblAccountNumberError" style="-fx-text-fill: red;" text="" />
                    </VBox>

                    <!-- Balance -->
                    <VBox spacing="6" GridPane.rowIndex="1" GridPane.columnIndex="0">
                        <Label text="Balance" styleClass="form-label"/>
                        <HBox styleClass="input-group" spacing="0">
                            <StackPane styleClass="input-prefix input-prefix-currency">
                                <Label text="DT" styleClass="input-prefix-text"/>
                            </StackPane>
                            <TextField fx:id="txtBalance" promptText="0.00"
                                       styleClass="text-field input-with-prefix"
                                       HBox.hgrow="ALWAYS"/>
                        </HBox>
                        <Label fx:id="lblBalanceError" style="-fx-text-fill: red;" text="" />
                    </VBox>

                    <!-- Date d ouverture -->
                    <VBox spacing="6" GridPane.rowIndex="1" GridPane.columnIndex="1">
                        <Label text="Date d ouverture" styleClass="form-label"/>
                        <DatePicker fx:id="dpOpeningDate" promptText="Selectionner une date"
                                    styleClass="date-picker" maxWidth="1.7976931348623157E308"/>
                        <Label fx:id="lblOpeningDateError" style="-fx-text-fill: red;" text="" />
                    </VBox>


                    <!-- Statut -->
                    <VBox spacing="6" GridPane.rowIndex="2" GridPane.columnIndex="0">
                        <Label text="Statut du compte" styleClass="form-label"/>
                        <ComboBox fx:id="cbStatus" promptText="Selectionner"
                                  styleClass="combo-box" maxWidth="1.7976931348623157E308">
                            <items>
                                <FXCollections fx:factory="observableArrayList">
                                    <String fx:value="Active"/>
                                    <String fx:value="Bloque"/>
                                    <String fx:value="Ferme"/>
                                </FXCollections>
                            </items>
                        </ComboBox>
                        <Label fx:id="lblStatusError" style="-fx-text-fill: red;" text="" />
                    </VBox>

                    <!-- Type de compte -->
                    <VBox spacing="6" GridPane.rowIndex="2" GridPane.columnIndex="1">
                        <Label text="Type de compte" styleClass="form-label"/>
                        <ComboBox fx:id="cbType" promptText="Selectionner le type"
                                  styleClass="combo-box" maxWidth="1.7976931348623157E308">
                            <items>
                                <FXCollections fx:factory="observableArrayList">
                                    <String fx:value="Courant"/>
                                    <String fx:value="Epargne"/>
                                    <String fx:value="Professionnel"/>
                                </FXCollections>
                            </items>
                        </ComboBox>
                        <Label fx:id="lblTypeError" style="-fx-text-fill: red;" text="" />
                    </VBox>

                    <!-- Plafond Retrait -->
                    <VBox spacing="6" GridPane.rowIndex="3" GridPane.columnIndex="0">
                        <Label text="Plafond de retrait" styleClass="form-label"/>
                        <HBox styleClass="input-group" spacing="0">
                            <StackPane styleClass="input-prefix input-prefix-currency">
                                <Label text="DT" styleClass="input-prefix-text"/>
                            </StackPane>
                            <TextField fx:id="txtWithdrawLimit" promptText="0.00"
                                       styleClass="text-field input-with-prefix"
                                       HBox.hgrow="ALWAYS"/>
                        </HBox>
                        <Label fx:id="lblWithdrawLimitError" style="-fx-text-fill: red;" text="" />
                    </VBox>

                    <!-- Plafond Virement -->
                    <VBox spacing="6" GridPane.rowIndex="3" GridPane.columnIndex="1">
                        <Label text="Plafond de virement" styleClass="form-label"/>
                        <HBox styleClass="input-group" spacing="0">
                            <StackPane styleClass="input-prefix input-prefix-currency">
                                <Label text="DT" styleClass="input-prefix-text"/>
                            </StackPane>
                            <TextField fx:id="txtTransferLimit" promptText="0.00"
                                       styleClass="text-field input-with-prefix"
                                       HBox.hgrow="ALWAYS"/>
                        </HBox>
                        <Label fx:id="lblTransferLimitError" style="-fx-text-fill: red;" text="" />
                    </VBox>

                </GridPane>

                <!-- Boutons actions Compte -->
                <HBox spacing="12" alignment="CENTER_RIGHT" styleClass="form-actions">
                    <Button styleClass="btn-outline" onAction="#clearForm">
                        <graphic>
                            <HBox spacing="6" alignment="CENTER">
                                <FontIcon iconLiteral="fas-eraser" styleClass="btn-icon"/>
                                <Label text="Vider"/>
                            </HBox>
                        </graphic>
                    </Button>
                    <Button styleClass="btn-danger" onAction="#deleteAccount">
                        <graphic>
                            <HBox spacing="6" alignment="CENTER">
                                <FontIcon iconLiteral="fas-trash-alt" styleClass="btn-icon-light"/>
                                <Label text="Supprimer"/>
                            </HBox>
                        </graphic>
                    </Button>
                    <Button styleClass="btn-primary" onAction="#saveAccount">
                        <graphic>
                            <HBox spacing="6" alignment="CENTER">
                                <FontIcon iconLiteral="fas-save" styleClass="btn-icon-light"/>
                                <Label text="Enregistrer les modifications"/>
                            </HBox>
                        </graphic>
                    </Button>
                </HBox>
            </VBox>

            <!-- ── Coffre Form (modifié) ───────────────────────────── -->
            <VBox fx:id="coffreFormContainer" styleClass="vault-form-container"
                  spacing="0" visible="false" managed="false">
                <Separator styleClass="section-divider"/>

                <HBox styleClass="vault-form-header" spacing="12" alignment="CENTER_LEFT">
                    <StackPane styleClass="vault-form-icon">
                        <FontIcon iconLiteral="fas-lock" styleClass="vault-form-icon-glyph"/>
                    </StackPane>
                    <VBox spacing="2" HBox.hgrow="ALWAYS">
                        <Label fx:id="lblCoffreFormTitle"
                               text="Configuration du coffre virtuel"
                               styleClass="vault-form-title"/>
                        <Label fx:id="lblCoffreFormSubtitle"
                               text="Creer un nouvel objectif d epargne"
                               styleClass="vault-form-subtitle"/>
                    </VBox>
                    <Button styleClass="btn-icon-close" onAction="#hideCoffreForm">
                        <graphic>
                            <FontIcon iconLiteral="fas-times" styleClass="close-icon"/>
                        </graphic>
                    </Button>
                </HBox>

                <VBox styleClass="vault-form-body" spacing="16">
                    <GridPane hgap="16" vgap="14">
                        <columnConstraints>
                            <ColumnConstraints percentWidth="50"/>
                            <ColumnConstraints percentWidth="50"/>
                        </columnConstraints>

                        <!-- ★ NOUVEAU : ligne pour la sélection du compte bancaire -->
                        <VBox spacing="6" GridPane.rowIndex="0" GridPane.columnIndex="0"
                              GridPane.columnSpan="2">
                            <Label text="Compte bancaire associé" styleClass="form-label"/>
                            <ComboBox fx:id="cmbCoffreCompte" promptText="Choisir un compte"
                                      styleClass="combo-box" maxWidth="1.7976931348623157E308"/>
                            <Label fx:id="lblCoffreCompteError" style="-fx-text-fill: red;" text="" />
                        </VBox>

                        <!-- Nom du coffre (rowIndex décalé à 1) -->
                        <VBox spacing="6" GridPane.rowIndex="1" GridPane.columnIndex="0"
                              GridPane.columnSpan="2">
                            <Label text="Nom du coffre" styleClass="form-label"/>
                            <HBox styleClass="input-group" spacing="0">
                                <StackPane styleClass="input-prefix">
                                    <FontIcon iconLiteral="fas-tag" styleClass="input-prefix-icon"/>
                                </StackPane>
                                <TextField fx:id="txtCoffreName"
                                           promptText="ex. Fonds vacances"
                                           styleClass="text-field input-with-prefix"
                                           HBox.hgrow="ALWAYS"/>
                            </HBox>
                            <Label fx:id="lblCoffreNameError" style="-fx-text-fill: red;" text="" />
                        </VBox>

                        <!-- Montant cible (rowIndex=2, column=0) -->
                        <VBox spacing="6" GridPane.rowIndex="2" GridPane.columnIndex="0">
                            <Label text="Montant cible" styleClass="form-label"/>
                            <HBox styleClass="input-group" spacing="0">
                                <StackPane styleClass="input-prefix input-prefix-currency">
                                    <Label text="DT" styleClass="input-prefix-text"/>
                                </StackPane>
                                <TextField fx:id="txtCoffreObjectif" promptText="0.00"
                                           styleClass="text-field input-with-prefix"
                                           HBox.hgrow="ALWAYS"/>
                            </HBox>
                            <Label fx:id="lblCoffreObjectifError" style="-fx-text-fill: red;" text="" />
                        </VBox>

                        <!-- Depot initial (rowIndex=2, column=1) -->
                        <VBox spacing="6" GridPane.rowIndex="2" GridPane.columnIndex="1">
                            <Label text="Depot initial" styleClass="form-label"/>
                            <HBox styleClass="input-group" spacing="0">
                                <StackPane styleClass="input-prefix input-prefix-currency">
                                    <Label text="DT" styleClass="input-prefix-text"/>
                                </StackPane>
                                <TextField fx:id="txtCoffreDepotInitial" promptText="0.00"
                                           styleClass="text-field input-with-prefix"
                                           HBox.hgrow="ALWAYS"/>
                            </HBox>
                            <Label fx:id="lblCoffreDepotError" style="-fx-text-fill: red;" text="" />
                        </VBox>

                        <!-- Date cible (rowIndex=3, column=0) -->
                        <VBox spacing="6" GridPane.rowIndex="3" GridPane.columnIndex="0">
                            <Label text="Date cible" styleClass="form-label"/>
                            <DatePicker fx:id="dpCoffreDateCible"
                                        promptText="Selectionner une date"
                                        styleClass="date-picker"
                                        maxWidth="1.7976931348623157E308"/>
                            <Label fx:id="lblCoffreDateError" style="-fx-text-fill: red;" text="" />
                        </VBox>

                        <!-- Statut du coffre (rowIndex=3, column=1) -->
                        <VBox spacing="6" GridPane.rowIndex="3" GridPane.columnIndex="1">
                            <Label text="Statut du coffre" styleClass="form-label"/>
                            <ComboBox fx:id="cbCoffreStatut" promptText="Selectionner"
                                      styleClass="combo-box"
                                      maxWidth="1.7976931348623157E308">
                                <items>
                                    <FXCollections fx:factory="observableArrayList">
                                        <String fx:value="Actif"/>
                                        <String fx:value="Verrouille"/>
                                        <String fx:value="Ferme"/>
                                    </FXCollections>
                                </items>
                            </ComboBox>
                            <Label fx:id="lblCoffreStatutError" style="-fx-text-fill: red;" text="" />
                        </VBox>

                        <!-- Checkboxes (rowIndex=4, colSpan=2) -->
                        <HBox spacing="16" GridPane.rowIndex="4" GridPane.columnIndex="0"
                              GridPane.columnSpan="2" alignment="CENTER_LEFT">
                            <CheckBox fx:id="chkVerrouiller"
                                      text="Verrouiller le coffre jusqu a la date cible"
                                      styleClass="check-box"/>
                            <CheckBox fx:id="chkDepotAuto"
                                      text="Activer le depot automatique"
                                      styleClass="check-box"/>


                        </HBox>
                    </GridPane>

                    <HBox spacing="12" alignment="CENTER_RIGHT">
                        <Button styleClass="btn-outline" onAction="#hideCoffreForm">
                            <graphic><Label text="Annuler"/></graphic>
                        </Button>
                        <Button styleClass="btn-accent" onAction="#saveCoffre">
                            <graphic>
                                <HBox spacing="6" alignment="CENTER">
                                    <FontIcon iconLiteral="fas-plus-circle"
                                              styleClass="btn-icon-light"/>
                                    <Label fx:id="lblCoffreBtnText" text="Creer le coffre"/>
                                </HBox>
                            </graphic>
                        </Button>
                    </HBox>
                </VBox>
            </VBox>
        </VBox>

        <!-- ── RIGHT : Account Grid (inchangé) ───────────────────────── -->
        <VBox styleClass="content-card" HBox.hgrow="ALWAYS" spacing="0">
            <HBox styleClass="card-header" spacing="14" alignment="CENTER_LEFT">
                <StackPane styleClass="card-header-icon">
                    <FontIcon iconLiteral="fas-layer-group"
                              styleClass="card-header-icon-glyph"/>
                </StackPane>
                <VBox spacing="2" HBox.hgrow="ALWAYS">
                    <Label text="Vos comptes" styleClass="card-header-title"/>
                    <Label text="Tous les comptes bancaires lies"
                           styleClass="card-header-subtitle"/>
                </VBox>
                <HBox styleClass="search-container" spacing="0" alignment="CENTER_LEFT">
                    <StackPane styleClass="search-icon-wrapper">
                        <FontIcon iconLiteral="fas-search" styleClass="search-icon"/>
                    </StackPane>
                    <TextField fx:id="txtSearch"
                               promptText="Rechercher des comptes..."
                               styleClass="search-input"/>
                </HBox>
            </HBox>

            <ScrollPane styleClass="comptes-scroll" fitToWidth="true" VBox.vgrow="ALWAYS">
                <VBox styleClass="card-body" spacing="20">

                    <!-- Filter Tabs — tous câblés au controller -->
                    <HBox styleClass="filter-tabs" spacing="8">
                        <Button fx:id="btnFilterAll"
                                text="All"
                                styleClass="filter-tab filter-tab-active"
                                onAction="#filterAll"/>
                        <Button fx:id="btnFilterCourant"
                                text="Courant"
                                styleClass="filter-tab"
                                onAction="#filterCourant"/>
                        <Button fx:id="btnFilterEpargne"
                                text="Epargne"
                                styleClass="filter-tab"
                                onAction="#filterEpargne"/>
                        <Button fx:id="btnFilterProfessionnel"
                                text="Professionnel"
                                styleClass="filter-tab"
                                onAction="#filterProfessionnel"/>
                    </HBox>

                    <!-- Grille de comptes — entièrement gérée par le controller -->
                    <FlowPane fx:id="comptesGrid"
                              styleClass="comptes-grid"
                              hgap="16" vgap="16"/>

                    <!-- ── Coffres Section ( slide-in ) ─────────── -->
                    <VBox fx:id="coffresDisplayContainer"
                          styleClass="vaults-section"
                          spacing="16"
                          visible="false"
                          managed="false">
                        <Separator styleClass="section-divider"/>

                        <HBox alignment="CENTER_LEFT" spacing="12">
                            <StackPane styleClass="vaults-section-icon">
                                <FontIcon iconLiteral="fas-lock"
                                          styleClass="vaults-section-icon-glyph"/>
                            </StackPane>
                            <VBox spacing="2" HBox.hgrow="ALWAYS">
                                <Label text="Coffres Virtuels"
                                       styleClass="vaults-section-title"/>
                                <Label text="Objectifs d epargne associes a ce compte"
                                       styleClass="vaults-section-subtitle"/>
                            </VBox>
                            <Button styleClass="btn-outline-small" onAction="#hideCoffres">
                                <graphic>
                                    <HBox spacing="4" alignment="CENTER">
                                        <FontIcon iconLiteral="fas-times"
                                                  styleClass="btn-icon-small"/>
                                        <Label text="Fermer"/>
                                    </HBox>
                                </graphic>
                            </Button>
                        </HBox>

                        <!-- FlowPane dynamique pour les coffres -->
                        <FlowPane fx:id="coffresCardsContainer" hgap="16" vgap="16"/>
                    </VBox>

                </VBox>
            </ScrollPane>
        </VBox>
    </HBox>
</VBox>