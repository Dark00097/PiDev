<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.shape.*?>
<?import javafx.collections.FXCollections?>
<?import java.lang.String?>

<VBox xmlns="http://javafx.com/javafx/17"
      xmlns:fx="http://javafx.com/fxml/1"
      fx:controller="com.nexora.bank.controllers.CreditController"
      stylesheets="@../css/Credit.css"
      styleClass="nx-entity-container" spacing="24">

    <!-- ══════════════════════════════════════════════════
         STAT CARDS
    ══════════════════════════════════════════════════ -->
    <HBox spacing="24" styleClass="nx-stats-row">

        <VBox styleClass="nx-stat-card" HBox.hgrow="ALWAYS">
            <HBox alignment="CENTER_LEFT" spacing="16">
                <StackPane styleClass="nx-stat-card-icon, nx-stat-card-icon-teal">
                    <SVGPath content="M9 12l2 2 4-4m6 2a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/>
                </StackPane>
                <VBox spacing="4">
                    <Label fx:id="lblCreditsAccordes" text="0" styleClass="nx-stat-card-value"/>
                    <Label text="Crédits Accordés" styleClass="nx-stat-card-label"/>
                </VBox>
            </HBox>
        </VBox>

        <VBox styleClass="nx-stat-card" HBox.hgrow="ALWAYS">
            <HBox alignment="CENTER_LEFT" spacing="16">
                <StackPane styleClass="nx-stat-card-icon, nx-stat-card-icon-gold">
                    <SVGPath content="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </StackPane>
                <VBox spacing="4">
                    <Label fx:id="lblMontantTotal" text="0.00 DT" styleClass="nx-stat-card-value"/>
                    <Label text="Montant Total" styleClass="nx-stat-card-label"/>
                </VBox>
            </HBox>
        </VBox>

        <VBox styleClass="nx-stat-card" HBox.hgrow="ALWAYS">
            <HBox alignment="CENTER_LEFT" spacing="16">
                <StackPane styleClass="nx-stat-card-icon, nx-stat-card-icon-blue">
                    <SVGPath content="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/>
                </StackPane>
                <VBox spacing="4">
                    <Label fx:id="lblCreditsEnCours" text="0" styleClass="nx-stat-card-value"/>
                    <Label text="Crédits en Cours" styleClass="nx-stat-card-label"/>
                </VBox>
            </HBox>
        </VBox>

    </HBox>

    <!-- ══════════════════════════════════════════════════
         MAIN CONTENT : FORMULAIRE + TABLEAU
    ══════════════════════════════════════════════════ -->
    <HBox spacing="24" VBox.vgrow="ALWAYS">

        <!-- ──────────────────────────────────────────────
             FORMULAIRE
        ────────────────────────────────────────────── -->
        <VBox styleClass="nx-card" prefWidth="560" minWidth="560" spacing="0">

            <!-- En-tête carte -->
            <HBox styleClass="nx-card-header" alignment="CENTER_LEFT" spacing="12">
                <StackPane styleClass="nx-stat-card-icon, nx-stat-card-icon-gold">
                    <SVGPath content="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                </StackPane>
                <VBox spacing="2">
                    <Label text="Crédit" styleClass="nx-card-title"/>
                    <Label text="Gérer les demandes de crédit" styleClass="nx-card-subtitle"/>
                </VBox>
            </HBox>

            <!-- Champs -->
            <ScrollPane styleClass="nx-form-scroll" fitToWidth="true" VBox.vgrow="ALWAYS">
                <VBox styleClass="nx-card-body" spacing="16">

                    <!-- Compte -->
                    <VBox styleClass="nx-form-group" spacing="8">
                        <Label text="Compte (ID)" styleClass="nx-label, nx-label-required"/>
                        <ComboBox fx:id="cmbCompte" promptText="Sélectionner un compte"
                                  styleClass="nx-select" maxWidth="Infinity"/>
                    </VBox>

                    <!-- Type Crédit -->
                    <VBox styleClass="nx-form-group" spacing="8">
                        <Label text="Type de Crédit" styleClass="nx-label, nx-label-required"/>
                        <ComboBox fx:id="cmbTypeCredit" promptText="Sélectionner un type"
                                  styleClass="nx-select" maxWidth="Infinity">
                            <items>
                                <FXCollections fx:factory="observableArrayList">
                                    <String fx:value="Crédit Immobilier"/>
                                    <String fx:value="Crédit Automobile"/>
                                    <String fx:value="Crédit Personnel"/>
                                    <String fx:value="Crédit Professionnel"/>
                                    <String fx:value="Hypotheque"/>
                                    <String fx:value="Education"/>
                                    <String fx:value="Pret auto"/>
                                </FXCollections>
                            </items>
                        </ComboBox>
                    </VBox>

                    <!-- Montant Demandé -->
                    <VBox styleClass="nx-form-group" spacing="8">
                        <Label text="Montant Demandé (DT)" styleClass="nx-label, nx-label-required"/>
                        <HBox styleClass="nx-input-wrapper">
                            <SVGPath content="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"
                                     styleClass="nx-input-icon"/>
                            <TextField fx:id="txtMontantDemande" promptText="Ex: 100000.00"
                                       styleClass="nx-input" HBox.hgrow="ALWAYS"/>
                        </HBox>
                    </VBox>

                    <!-- Montant Accordé -->
                    <VBox styleClass="nx-form-group" spacing="8">
                        <Label text="Montant Accordé (DT)" styleClass="nx-label"/>
                        <HBox styleClass="nx-input-wrapper">
                            <SVGPath content="M9 12l2 2 4-4m6 2a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"
                                     styleClass="nx-input-icon"/>
                            <TextField fx:id="txtMontantAccord" promptText="Montant approuvé"
                                       styleClass="nx-input" HBox.hgrow="ALWAYS"/>
                        </HBox>
                    </VBox>

                    <!-- Durée -->
                    <VBox styleClass="nx-form-group" spacing="8">
                        <Label text="Durée (mois)" styleClass="nx-label, nx-label-required"/>
                        <HBox styleClass="nx-input-wrapper">
                            <SVGPath content="M12 8v4l3 3m6-3a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"
                                     styleClass="nx-input-icon"/>
                            <TextField fx:id="txtDuree" promptText="Ex: 60"
                                       styleClass="nx-input" HBox.hgrow="ALWAYS"/>
                        </HBox>
                    </VBox>

                    <!-- Taux d'Intérêt -->
                    <VBox styleClass="nx-form-group" spacing="8">
                        <Label text="Taux d'Intérêt (%)" styleClass="nx-label, nx-label-required"/>
                        <HBox styleClass="nx-input-wrapper">
                            <SVGPath content="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 0 0-2-2H7a2 2 0 0 0-2 2v16"
                                     styleClass="nx-input-icon"/>
                            <TextField fx:id="txtTauxInteret" promptText="Ex: 7.5"
                                       styleClass="nx-input" HBox.hgrow="ALWAYS"/>
                        </HBox>
                    </VBox>

                    <!-- Mensualité (calculée auto) -->
                    <VBox styleClass="nx-form-group" spacing="8">
                        <Label text="Mensualité (DT)" styleClass="nx-label"/>
                        <HBox styleClass="nx-input-wrapper">
                            <SVGPath content="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z"
                                     styleClass="nx-input-icon"/>
                            <TextField fx:id="txtMensualite" promptText="Calculée automatiquement"
                                       styleClass="nx-input, nx-input-calculated" HBox.hgrow="ALWAYS"/>
                        </HBox>
                    </VBox>

                    <!-- Montant Restant -->
                    <VBox styleClass="nx-form-group" spacing="8">
                        <Label text="Montant Restant (DT)" styleClass="nx-label"/>
                        <HBox styleClass="nx-input-wrapper">
                            <SVGPath content="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"
                                     styleClass="nx-input-icon"/>
                            <TextField fx:id="txtMontantRestant" promptText="Solde restant"
                                       styleClass="nx-input, nx-input-calculated" HBox.hgrow="ALWAYS"/>
                        </HBox>
                    </VBox>

                    <!-- Date de Demande -->
                    <VBox styleClass="nx-form-group" spacing="8">
                        <Label text="Date de Demande" styleClass="nx-label, nx-label-required"/>
                        <HBox styleClass="nx-input-wrapper">
                            <SVGPath content="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z"
                                     styleClass="nx-input-icon"/>
                            <DatePicker fx:id="dpDateDemande" styleClass="nx-datepicker"
                                        HBox.hgrow="ALWAYS"/>
                        </HBox>
                    </VBox>

                    <!-- Statut -->
                    <!-- ✅ FIX: "En attente" ajouté pour correspondre aux données DB -->
                    <VBox styleClass="nx-form-group" spacing="8">
                        <Label text="Statut" styleClass="nx-label, nx-label-required"/>
                        <ComboBox fx:id="cmbStatut" promptText="Sélectionner un statut"
                                  styleClass="nx-select" maxWidth="Infinity">
                            <items>
                                <FXCollections fx:factory="observableArrayList">
                                    <String fx:value="En cours"/>
                                    <String fx:value="En attente"/>
                                    <String fx:value="Accepté"/>
                                    <String fx:value="Refusé"/>
                                    <String fx:value="Remboursé"/>
                                    <String fx:value="Annulé"/>
                                </FXCollections>
                            </items>
                        </ComboBox>
                    </VBox>

                </VBox>
            </ScrollPane>

            <!-- Footer formulaire -->
            <HBox styleClass="nx-card-footer" spacing="12" alignment="CENTER_RIGHT">
                <Button text="Annuler"
                        styleClass="nx-btn, nx-btn-outline"
                        onAction="#handleAnnuler"/>
                <Button text="Supprimer"
                        styleClass="nx-btn, nx-btn-danger"
                        onAction="#handleSupprimer"/>
                <Button fx:id="btnAjouter"
                        text="Enregistrer"
                        styleClass="nx-btn, nx-btn-primary"
                        onAction="#handleAjouter"/>
            </HBox>

        </VBox>

        <!-- ──────────────────────────────────────────────
             TABLEAU
        ────────────────────────────────────────────── -->
        <VBox styleClass="nx-card" HBox.hgrow="ALWAYS" spacing="0">

            <!-- En-tête tableau -->
            <HBox styleClass="nx-card-header" alignment="CENTER_LEFT" spacing="16">
                <VBox spacing="2" HBox.hgrow="ALWAYS">
                    <Label text="Liste des Crédits" styleClass="nx-card-title"/>
                    <Label text="Gérer toutes les demandes de crédit" styleClass="nx-card-subtitle"/>
                </VBox>

                <!-- Recherche -->
                <HBox styleClass="nx-table-search" alignment="CENTER_LEFT" spacing="8">
                    <SVGPath content="M21 21l-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"
                             styleClass="nx-search-icon-sm"/>
                    <TextField fx:id="txtRecherche" promptText="Rechercher..."
                               styleClass="nx-search-input-sm" prefWidth="200"/>
                </HBox>

                <!-- Tris -->
                <MenuButton text="Trier" styleClass="nx-btn, nx-btn-outline-sm">
                    <items>
                        <MenuItem text="Par Type"    onAction="#trierParType"/>
                        <MenuItem text="Par Montant" onAction="#trierParMontant"/>
                        <MenuItem text="Par Date"    onAction="#trierParDate"/>
                        <MenuItem text="Par Statut"  onAction="#trierParStatut"/>
                    </items>
                </MenuButton>

                <Button text="Export PDF"
                        styleClass="nx-btn, nx-btn-secondary-sm"
                        onAction="#exporterPDF"/>
            </HBox>

            <!-- Tableau -->
            <VBox styleClass="nx-table-container" VBox.vgrow="ALWAYS">
                <TableView fx:id="tableCredits" styleClass="nx-table" VBox.vgrow="ALWAYS">
                    <columns>
                        <TableColumn fx:id="colCompte"         text="Compte ID"   prefWidth="90"/>
                        <TableColumn fx:id="colType"           text="Type"        prefWidth="140"/>
                        <TableColumn fx:id="colMontantDemande" text="Demandé"     prefWidth="110"/>
                        <TableColumn fx:id="colMontantAccord"  text="Accordé"     prefWidth="110"/>
                        <TableColumn fx:id="colDuree"          text="Durée"       prefWidth="75"/>
                        <TableColumn fx:id="colTaux"           text="Taux"        prefWidth="70"/>
                        <TableColumn fx:id="colMensualite"     text="Mensualité"  prefWidth="100"/>
                        <TableColumn fx:id="colRestant"        text="Restant"     prefWidth="100"/>
                        <TableColumn fx:id="colDate"           text="Date"        prefWidth="95"/>
                        <TableColumn fx:id="colStatut"         text="Statut"      prefWidth="100"/>
                        <TableColumn fx:id="colActions"        text="Actions"     prefWidth="90"/>
                    </columns>
                </TableView>
            </VBox>

            <!-- Footer tableau -->
            <HBox styleClass="nx-card-footer, nx-table-footer" alignment="CENTER" spacing="16">
                <Label fx:id="lblTableInfo" text="Affichage de 0 crédits"
                       styleClass="nx-table-info"/>
                <Region HBox.hgrow="ALWAYS"/>
                <Button text="Statistiques"
                        styleClass="nx-btn, nx-btn-secondary"
                        onAction="#ouvrirStatistiques"/>
                <Button text="Envoyer Email"
                        styleClass="nx-btn, nx-btn-gold"
                        onAction="#envoyerEmail"/>
            </HBox>

        </VBox>

    </HBox>

</VBox>
